---
title: "Avalições Auditor Crawler"
output:
    html_document:
    css: styles.css
theme: sandstone
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse) # 
library(broom)
library(jsonlite) # Ler dados json
library(dplyr) # 
library(here)
library(DT)
library(boot)
library(ggalt)

set.seed(12345)
library(ggplot2)
library(ggbeeswarm)
source(here::here("code/lib.R"))
theme_set(theme_bw())

```

## Lendo os dados

```{r read}
resultados_avaliacoes_exp01 = read_avaliacoes()
resultados_avaliacoes_exp01[is.na(resultados_avaliacoes_exp01)] <- ""

gararito = read_gabaritos()
gararito[is.na(gararito)] <- ""

empresas_portais <- readr::read_csv(here::here("data/empresas_portais.csv"))
```

## Removendo avaliações que não pertecem ao experimento 01

Para uma avaliação ser considerada válida ela precisa conter 61 itens. Vamos desconsiderar as avaliações que não contém esse número

Vamos remover também o município de Curral de Cima que encontra-se com seu portal de transparência fora do ar.

```{r}
resultados_avaliacoes_exp01 <- resultados_avaliacoes_exp01 %>% 
  filter(tipo_exp == 'all_itens' & (municipio != 'Curral de Cima' & municipio != 'todo'))

```



## Adicionando combinação encontrada em cada município no gabarito

```{r}
empresas_portais <- empresas_portais %>% 
    select(municipio, fornecedor)

gararito<-left_join(gararito, empresas_portais, by=c("municipio"))
```


## Juntando Avaliações e Gabaritos

```{r}
# concatena os dois csv o do gabarito e avaliações do crawler
data<-left_join(resultados_avaliacoes_exp01, gararito, by=c("municipio", "item", "criterio"))
```

## Sumarizando as avaliações

```{r}

sumarise_exp01 <- data %>% 
    group_by(municipio, criterio, item, aproach, date) %>% 
    mutate(
           
           #verifica se a avaliação foi acertiva
           tp = (valid == TRUE 
           & valid == encontrado 
           #valida se no gabarito e na avaliação o item foi encontrado na mesma url 
           & (grepl(local_encontrado, pathSought) |
                  grepl(local_encontrado_2, pathSought))) | (valid == FALSE 
           & valid == encontrado),
           
           fn =  valid == FALSE 
           & encontrado == TRUE,
           
           fp = valid == TRUE 
           & encontrado == FALSE
          )

sumarise_exp01 %>%
    datatable(options = list(pageLength = 5),  rownames = FALSE, class = 'cell-border stripe')
```

## Quantificando métricas

```{r}

metricas_result_exp01 <- sumarise_exp01 %>% 
    #filter(!is.na(aproach )) %>% 
    group_by(municipio, aproach, date) %>% 
    summarise(
        total_itens = n(),
        tp_total = sum(tp), 
        fn_total = sum(fn),
        fp_total = sum(fp),
        
        #cálculo das métricas 
        recall = tp_total/(tp_total + fn_total),
        precision =  tp_total/(tp_total + fp_total),
        f1_score = (2*(recall*precision))/(recall+precision),
        
        #tempo das avaliações
        median_duration_min = median(durationMin),
        median_duration = median(duration),
        max_duration = max(duration),
        max_durationMin = max(durationMin),
        median_num_access_node = median(contNodeNumberAccess),
        max_num_access_node = max(contNodeNumberAccess),
        all_access_node = sum(contNodeNumberAccess),
        combination = last(fornecedor),
        tipo_exp = last(tipo_exp)
    )


metricas_result_exp01 <- metricas_result_exp01 %>%
  filter(total_itens == 61)

metricas_result_exp01 %>% 
    write_csv(here::here("data/resultados_sumarizado_exp01.csv"))

metricas_result_exp01 %>%
  arrange(desc(recall))

```

## Avaliações por abordagem

```{r}
metricas_result_exp01 %>%
    group_by(aproach) %>% 
    summarise(ocorrencia = n()) %>%
    ggplot(aes(y=ocorrencia, x=reorder(aproach, +(ocorrencia)))) + 
    geom_bar(stat = "identity",  fill="#5499C7") + 
    ggtitle("Número de Avaliações por Abordagem") +
    xlab("Abordagem") + 
    ylab("Número de avaliações") +
    coord_flip()
```

## Número de Avaliações por abordagem

```{r}
metricas_result_exp01 %>%
    group_by(municipio) %>%
    summarise(bfs = sum(aproach == 'bfs'), dfs = sum(aproach == 'dfs'), bandit = sum(aproach == 'bandit')) %>%
    arrange(desc(dfs)) %>%
    datatable(options = list(pageLength = 10),  rownames = FALSE, class = 'cell-border stripe')
```

## Todas as Avaliações

```{r}
metricas_result_exp01 %>%
    select(municipio, aproach, date, recall, precision, f1_score) %>%
    arrange(desc(recall)) %>% 
    datatable(options = list(pageLength = 10),  rownames = FALSE, class = 'cell-border stripe')
```

## F1-score 

```{r}
metricas_result_exp01 %>% 
  ggplot(aes(x = aproach, y = f1_score)) +
  geom_boxplot() +
  geom_jitter(aes(color=aproach), alpha=0.4) +
  scale_color_manual(values=c("#999999", "#f39422", "#537ec5", '#293a80')) +
  labs(x='Abordagem', y="F1 Score", title="Avaliações por Abordagem")


metricas_result_exp01 %>%
  group_by(aproach)  %>%
  ggplot(aes(x = aproach, y = f1_score)) + 
  geom_dotplot(aes(fill = aproach),
               color='white',
               binaxis = "y", 
               binwidth = 0.009,
               stackdir = "center") +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median,
                 geom = "crossbar", width = 0.5, alpha=0.3,aes(colour='Mediana'), ) +
  scale_linetype_manual("", values=c("median"="x")) +
  scale_fill_manual(values=c("#999999", "#f39422", "#537ec5", '#293a80')) +
  scale_colour_manual(values=c("black", "black", "#56B4E9", '#293a80')) +
  labs(x='Abordagem', y="F1 Score", title="Avaliações por Abordagem", color = "")
``` 

## Intervalo de Confiança da Mediana encontrada do F1 Score para cada Abordagem


```{r}
#Calcula a media das posições escolhidas nas buscas.
set.seed(123)

f1_score_boot <- function (d, i) {
    dt<-d[i,]
    c(
          median(dt$f1_score)
    )
}

boot.aproach_exp01 <- metricas_result_exp01 %>%
  group_by(aproach) %>% 
  mutate(cors_boot = list(
      boot(
          data = metricas_result_exp01, 
          statistic = f1_score_boot, 
          R = 4000
          )
      )
     )

ics.aproach_exp01 <- boot.aproach_exp01 %>% 
    group_by(aproach) %>% 
    summarise(
        median_value = median(f1_score),
        ci = list(tidy(cors_boot[[1]], 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE))
        
    ) %>% 
    unnest(ci) 

  
ics.aproach_exp01 %>%  
  ggplot() + 
  geom_errorbar(aes(x = aproach, y = statistic, ymin = conf.low, ymax = conf.high), width = 0.05) +
  geom_point(aes(x=aproach, y=median_value), color='red', size=3) 


```


## F1 Score por cada Município da Amostra 


```{r}
metricas_result_exp01 %>% 
  group_by(municipio) %>% 
  summarise(max_value = max(f1_score), min_value = min(f1_score), median_value=median(f1_score)) %>% 
  ggplot(aes(y=municipio)) + 
  geom_point(aes(x=min_value, color='#293a80'), size=3) +
  geom_point(aes(x= max_value, color='#537ec5'), size=3)  +
  geom_dumbbell(color="#e3e2e1", aes(x = min_value, xend = max_value), colour_x = "#293a80", colour_xend = "#537ec5", size=3,
                dot_guide=TRUE, dot_guide_size=0.25) + 
  geom_point(aes(x= median_value, color='#f39422'), size=3, alpha=0.5) +
  scale_color_manual(name = "", values = c("#293a80", "#537ec5", "#f39422"), labels = c("Mínimo", "Máximo", "Mediana")) +
  labs(x='F1 Score', y=NULL, title="F1 Score Por Município") 
```

## Intervalo de Confiança da Mediana encontrada do F1 Score para cada Abordagem


```{r}

#Calcula a media das posições escolhidas nas buscas.
set.seed(123)

f1_score_boot <- function (d, i) {
    dt<-d[i,]
    c(
          median(dt$f1_score)
    )
}

boot.aproach_exp01 <- metricas_result_exp01 %>%
  group_by(aproach) %>% 
  mutate(cors_boot = list(
      boot(
          data = metricas_result_exp01, 
          statistic = f1_score_boot, 
          R = 4000
          )
      )
     )

ics.aproach_exp01_1 <- boot.aproach_exp01 %>% 
    group_by(municipio, aproach) %>% 
    summarise(
        median_value = median(f1_score),
        ci = list(tidy(cors_boot[[1]], 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE))
        
    ) %>% 
    unnest(ci) 

  
ics.aproach_exp01_1 %>% 
  ggplot() + 
  geom_errorbar(aes(x = municipio, y = statistic, ymin = conf.low, ymax = conf.high), width = 0.05) +
  geom_point(aes(x=municipio, y=median_value), color='red', size=1) +
  coord_flip() +
  facet_grid(. ~aproach) 
  

```



## Tempo de Duração  

```{r}
metricas_result_exp01 %>%
    ggplot(aes(x = reorder(aproach, +(max_durationMin)), y = max_durationMin)) +
    geom_boxplot() 

```

## Nós Acessados  


```{r}

metricas_result_exp01 %>%
  ggplot(aes(x = reorder(aproach, +(max_num_access_node)), y = max_num_access_node)) +
  geom_boxplot()
```


## f1 Score por combinação

```{r}

metricas_result_exp01 %>% 
  group_by(combination) %>% 
  summarise(max_value = max(f1_score), min_value = min(f1_score), median_value=median(f1_score)) %>% 
  ggplot(aes(y=combination)) + 
  geom_point(aes(x=min_value, color='#293a80'), size=3) +
  geom_point(aes(x= max_value, color='#537ec5'), size=3)  +
  geom_dumbbell(color="#e3e2e1", aes(x = min_value, xend = max_value), colour_x = "#293a80", colour_xend = "#537ec5", size=3,
                dot_guide=TRUE, dot_guide_size=0.25) + 
  geom_point(aes(x= median_value, color='#f39422'), size=3, alpha=0.7) +
  scale_color_manual(name = "", values = c("#293a80", "#537ec5", "#f39422"), labels = c("Mínimo", "Máximo", "Mediana")) +
  labs(x='F1 Score', y=NULL, title="Combinações por F1 Score") 

```

## Número de nós acessados por combinação

```{r}


metricas_result_exp01 %>% 
  group_by(combination) %>% 
  summarise(max_value = max(max_num_access_node), min_value = min(max_num_access_node), median_value=median(max_num_access_node)) %>% 
  ggplot(aes(y=combination)) + 
  geom_point(aes(x=min_value, color='#293a80'), size=3) +
  geom_point(aes(x= max_value, color='#537ec5'), size=3)  +
  geom_dumbbell(color="#e3e2e1", aes(x = min_value, xend = max_value), colour_x = "#293a80", colour_xend = "#537ec5", size=3,
                dot_guide=TRUE, dot_guide_size=0.25) + 
  geom_point(aes(x= median_value, color='#f39422'), size=3, alpha=0.7) +
  scale_color_manual(name = "", values = c("#293a80", "#537ec5", "#f39422"), labels = c("Mínimo", "Máximo", "Mediana")) +
  labs(x='Número de nós', y=NULL, title="Combinações Por Número de Nós Acessados") 
```

## Duração das avaliações por combinações

```{r}
metricas_result_exp01 %>% 
  group_by(combination) %>% 
  summarise(max_value = max(max_durationMin), min_value = min(max_durationMin), median_value=median(max_durationMin)) %>% 
  ggplot(aes(y=combination)) + 
  geom_point(aes(x=min_value, color='#293a80'), size=3) +
  geom_point(aes(x= max_value, color='#537ec5'), size=3)  +
  geom_dumbbell(color="#e3e2e1", aes(x = min_value, xend = max_value), colour_x = "#293a80", colour_xend = "#537ec5", size=3,
                dot_guide=TRUE, dot_guide_size=0.25) + 
  geom_point(aes(x= median_value, color='#f39422'), size=3, alpha=0.7) +
  scale_color_manual(name = "", values = c("#293a80", "#537ec5", "#f39422"), labels = c("Mínimo", "Máximo", "Mediana")) +
  labs(x='Minutos', y=NULL, title="Combinações Por Tempo de Duração") 
```


